name: YFL U11 Form Guide – Weekly Automation

on:
  schedule:
    # Every Tuesday at 18:00 UAE (14:00 UTC)
    - cron: "0 14 * * TUE"
  workflow_dispatch: {}

jobs:
  run-scraper:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------------------------------
    # 1) CHECKOUT REPOSITORY
    # -----------------------------------------------------
    - name: Checkout Repo
      uses: actions/checkout@v4

    # -----------------------------------------------------
    # 2) SET UP PYTHON
    # -----------------------------------------------------
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    # -----------------------------------------------------
    # 3) INSTALL PYTHON DEPENDENCIES
    # -----------------------------------------------------
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install playwright google-auth google-auth-oauthlib google-api-python-client pandas bs4 python-dateutil nest_asyncio

    # -----------------------------------------------------
    # 4) INSTALL PLAYWRIGHT BROWSERS
    # -----------------------------------------------------
    - name: Install Playwright Chromium
      run: |
        playwright install chromium
        playwright install-deps chromium

    # -----------------------------------------------------
    # 5) RECREATE client_secret.json FROM GITHUB SECRET
    # -----------------------------------------------------
    - name: Restore client_secret.json
      run: |
        echo "${{ secrets.CLIENT_SECRET_JSON }}" > client_secret.json

    # -----------------------------------------------------
    # 6) RECREATE gmail_token.json FROM GITHUB SECRET
    # -----------------------------------------------------
    - name: Restore gmail_token.json
      run: |
        echo "${{ secrets.GMAIL_TOKEN_JSON }}" > gmail_token.json

    # -----------------------------------------------------
    # 7) CREATE ENV VARS FOR LOGIN CREDENTIALS
    # -----------------------------------------------------
    - name: Debug secrets (safe)
      run: |
        echo "EMAIL_RECEIVER is: ${EMAIL_RECEIVER:-<empty>}"
      env:
      EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
      
    - name: Export Environment Variables
      run: |
        echo "YFL_USERNAME=${{ secrets.YFL_USERNAME }}" >> $GITHUB_ENV
        echo "YFL_PASSWORD=${{ secrets.YFL_PASSWORD }}" >> $GITHUB_ENV

    # -----------------------------------------------------
    # 8) RUN THE PYTHON SCRAPER
    # -----------------------------------------------------
    - name: Run Scraper
      run: |
        python main.py

    # -----------------------------------------------------
    # 9) OPTIONAL — Upload Output HTML as Artifact
    # -----------------------------------------------------
    - name: Upload Artifact (HTML report)
      uses: actions/upload-artifact@v4
      with:
        name: yfl_u11_form_guide
        path: yfl_u11_form_guide.html
